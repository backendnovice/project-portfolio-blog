<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/common :: html-head}">
    <title>Change Password</title>
</head>
<body>
    <div class="container">
        <form th:method="post" class="form-change-password" th:action="@{~/member/help/password}">
            <div>
                <input type="password" id="password-old" name="password-old" placeholder="Current Password">
                <span class="text-danger" id="error-password" hidden>Wrong Password.</span>
            </div>
            <div>
                <input type="password" id="password" name="password" placeholder="New Password">
                <input type="password" id="password-check" name="password-check" placeholder="Check Password">
                <span class="text-danger" id="error-password-check" hidden>New Password Error.</span>
            </div>
            <div>
                <button type="button" id="btn-change">Change</button>
                <button type="button" id="btn-cancel" th:onclick="|location.href='@{~/member/modify}'|">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        $(function () {
            $('#btn-change').click(function() {
                validate();
            });
        });

        function validate() {
            let passwordOld = $('#password-old').val();
            let password = $('#password').val();
            let passwordCheck = $('#password-check').val();
            let hasError = false;

            if((!password || !passwordCheck) || (password !== passwordCheck)) {
                $('#error-password-check').removeAttr('hidden');
                hasError = true;
            }
            else {
                $('#error-password-check').attr('hidden');
            }

            if(!hasError) {
                $.ajax({
                    type: 'post',
                    url: '/member/api/password',
                    data: JSON.stringify({
                        password: passwordOld
                    }),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (response) {
                        if(response.isMatch) {
                            $('#error-password').attr('hidden');
                            $('.form-change-password').submit();
                        }else {
                            $('#error-password').removeAttr('hidden');
                        }
                    },
                    error: function () {
                        console.log('AJAX Error...');
                    }
                });
            }
        }
    </script>
</body>
</html>